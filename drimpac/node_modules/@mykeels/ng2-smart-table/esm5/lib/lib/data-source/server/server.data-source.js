import * as tslib_1 from "tslib";
import { HttpParams } from '@angular/common/http';
import { LocalDataSource } from '../local/local.data-source';
import { ServerSourceConf } from './server-source.conf';
import { getDeepFromObject } from '../../helpers';
import { map, finalize } from 'rxjs/operators';
import { Subject } from 'rxjs';
var ServerDataSource = /** @class */ (function (_super) {
    tslib_1.__extends(ServerDataSource, _super);
    function ServerDataSource(http, conf) {
        if (conf === void 0) { conf = {}; }
        var _this = _super.call(this) || this;
        _this.http = http;
        _this.lastRequestCount = 0;
        _this.onRequestStartSource = new Subject();
        _this.onRequestEndSource = new Subject();
        _this.onRequestCompleteSource = new Subject();
        _this.onRequestErrorSource = new Subject();
        _this.conf = new ServerSourceConf(conf);
        if (!_this.conf.endPoint) {
            throw new Error('At least endPoint must be specified as a configuration of the server data source.');
        }
        return _this;
    }
    ServerDataSource.prototype.count = function () {
        return this.lastRequestCount;
    };
    ServerDataSource.prototype.getElements = function () {
        var _this = this;
        return this.requestElements()
            .pipe(map(function (res) {
            _this.lastRequestCount = _this.extractTotalFromResponse(res);
            _this.data = _this.extractDataFromResponse(res);
            return _this.data;
        })).toPromise();
    };
    /**
     * Extracts array of data from server response
     * @param res
     * @returns {any}
     */
    ServerDataSource.prototype.extractDataFromResponse = function (res) {
        var rawData = res.body;
        var data = !!this.conf.dataKey ? getDeepFromObject(rawData, this.conf.dataKey, []) : rawData;
        if (data instanceof Array) {
            return data;
        }
        throw new Error("Data must be an array.\n    Please check that data extracted from the server response by the key '" + this.conf.dataKey + "' exists and is array.");
    };
    /**
     * Extracts total rows count from the server response
     * Looks for the count in the heders first, then in the response body
     * @param res
     * @returns {any}
     */
    ServerDataSource.prototype.extractTotalFromResponse = function (res) {
        if (res.headers.has(this.conf.totalKey)) {
            return +res.headers.get(this.conf.totalKey);
        }
        else {
            var rawData = res.body;
            return getDeepFromObject(rawData, this.conf.totalKey, 0);
        }
    };
    ServerDataSource.prototype.requestElements = function () {
        var _this = this;
        var httpParams = this.createRequesParams();
        this.emitOnRequestStart(httpParams);
        return this.http.get(this.conf.endPoint, { params: httpParams, observe: 'response' }).pipe(finalize(function () { return _this.emitOnRequestEnd(); })).pipe(map(function (res) {
            _this.emitOnRequestComplete(res);
            return res;
        }, function (err) {
            _this.emitOnRequestError(err);
            return err;
        }));
    };
    ServerDataSource.prototype.onRequestStart = function () {
        return this.onRequestStartSource.asObservable();
    };
    ServerDataSource.prototype.onRequestEnd = function () {
        return this.onRequestEndSource.asObservable();
    };
    ServerDataSource.prototype.onRequestComplete = function () {
        return this.onRequestCompleteSource.asObservable();
    };
    ServerDataSource.prototype.onRequestError = function () {
        return this.onRequestErrorSource.asObservable();
    };
    ServerDataSource.prototype.emitOnRequestStart = function (element) {
        this.onRequestStartSource.next(element);
    };
    ServerDataSource.prototype.emitOnRequestEnd = function () {
        this.onRequestEndSource.next();
    };
    ServerDataSource.prototype.emitOnRequestComplete = function (element) {
        this.onRequestCompleteSource.next(element);
    };
    ServerDataSource.prototype.emitOnRequestError = function (element) {
        this.onRequestErrorSource.next(element);
    };
    ServerDataSource.prototype.createRequesParams = function () {
        var httpParams = new HttpParams();
        httpParams = this.addSortRequestParams(httpParams);
        httpParams = this.addFilterRequestParams(httpParams);
        return this.addPagerRequestParams(httpParams);
    };
    ServerDataSource.prototype.addSortRequestParams = function (httpParams) {
        var _this = this;
        if (this.sortConf) {
            this.sortConf.forEach(function (fieldConf) {
                httpParams = httpParams.set(_this.conf.sortFieldKey, fieldConf.field);
                httpParams = httpParams.set(_this.conf.sortDirKey, fieldConf.direction.toUpperCase());
            });
        }
        return httpParams;
    };
    ServerDataSource.prototype.addFilterRequestParams = function (httpParams) {
        var _this = this;
        if (this.filterConf.filters) {
            this.filterConf.filters.forEach(function (fieldConf) {
                if (fieldConf['search']) {
                    httpParams = httpParams.set(_this.conf.filterFieldKey.replace('#field#', fieldConf['field']), fieldConf['search']);
                }
            });
        }
        return httpParams;
    };
    ServerDataSource.prototype.addPagerRequestParams = function (httpParams) {
        if (this.pagingConf && this.pagingConf['page'] && this.pagingConf['perPage']) {
            httpParams = httpParams.set(this.conf.pagerPageKey, this.pagingConf['page']);
            httpParams = httpParams.set(this.conf.pagerLimitKey, this.pagingConf['perPage']);
        }
        return httpParams;
    };
    return ServerDataSource;
}(LocalDataSource));
export { ServerDataSource };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLmRhdGEtc291cmNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQG15a2VlbHMvbmcyLXNtYXJ0LXRhYmxlLyIsInNvdXJjZXMiOlsibGliL2xpYi9kYXRhLXNvdXJjZS9zZXJ2ZXIvc2VydmVyLmRhdGEtc291cmNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQWMsVUFBVSxFQUFnQixNQUFNLHNCQUFzQixDQUFDO0FBRzVFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN4RCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFbEQsT0FBTyxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMvQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRS9CO0lBQXNDLDRDQUFlO0lBVW5ELDBCQUFzQixJQUFnQixFQUFFLElBQWdDO1FBQWhDLHFCQUFBLEVBQUEsU0FBZ0M7UUFBeEUsWUFDRSxpQkFBTyxTQU9SO1FBUnFCLFVBQUksR0FBSixJQUFJLENBQVk7UUFONUIsc0JBQWdCLEdBQVcsQ0FBQyxDQUFDO1FBQzdCLDBCQUFvQixHQUFHLElBQUksT0FBTyxFQUFjLENBQUM7UUFDakQsd0JBQWtCLEdBQUcsSUFBSSxPQUFPLEVBQU8sQ0FBQztRQUN4Qyw2QkFBdUIsR0FBRyxJQUFJLE9BQU8sRUFBd0IsQ0FBQztRQUM5RCwwQkFBb0IsR0FBRyxJQUFJLE9BQU8sRUFBd0IsQ0FBQztRQUtuRSxLQUFJLENBQUMsSUFBSSxHQUFHLElBQUksZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFdkMsSUFBSSxDQUFDLEtBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ3ZCLE1BQU0sSUFBSSxLQUFLLENBQUMsbUZBQW1GLENBQUMsQ0FBQztTQUN0Rzs7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QVMsQ0FBQyxDQUFDLENBQUM7U0FDbEY7UUFFRCxPQUFPLFVBQVUsQ0FBQztJQUNwQixDQUFDO0lBQ0gsdUJBQUM7QUFBRCxDQUFDLEFBOUpELENBQXNDLGVBQWUsR0E4SnBEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cFBhcmFtcywgSHR0cFJlc3BvbnNlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQgeyBMb2NhbERhdGFTb3VyY2UgfSBmcm9tICcuLi9sb2NhbC9sb2NhbC5kYXRhLXNvdXJjZSc7XG5pbXBvcnQgeyBTZXJ2ZXJTb3VyY2VDb25mIH0gZnJvbSAnLi9zZXJ2ZXItc291cmNlLmNvbmYnO1xuaW1wb3J0IHsgZ2V0RGVlcEZyb21PYmplY3QgfSBmcm9tICcuLi8uLi9oZWxwZXJzJztcblxuaW1wb3J0IHsgbWFwLCBmaW5hbGl6ZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcblxuZXhwb3J0IGNsYXNzIFNlcnZlckRhdGFTb3VyY2UgZXh0ZW5kcyBMb2NhbERhdGFTb3VyY2Uge1xuXG4gIHByb3RlY3RlZCBjb25mOiBTZXJ2ZXJTb3VyY2VDb25mO1xuXG4gIHByb3RlY3RlZCBsYXN0UmVxdWVzdENvdW50OiBudW1iZXIgPSAwO1xuICBwcm90ZWN0ZWQgb25SZXF1ZXN0U3RhcnRTb3VyY2UgPSBuZXcgU3ViamVjdDxIdHRwUGFyYW1zPigpO1xuICBwcm90ZWN0ZWQgb25SZXF1ZXN0RW5kU291cmNlID0gbmV3IFN1YmplY3Q8YW55PigpO1xuICBwcm90ZWN0ZWQgb25SZXF1ZXN0Q29tcGxldGVTb3VyY2UgPSBuZXcgU3ViamVjdDxIdHRwUmVzcG9uc2U8T2JqZWN0Pj4oKTtcbiAgcHJvdGVjdGVkIG9uUmVxdWVzdEVycm9yU291cmNlID0gbmV3IFN1YmplY3Q8SHR0cFJlc3BvbnNlPE9iamVjdD4+KCk7XG5cbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIGh0dHA6IEh0dHBDbGllbnQsIGNvbmY6IFNlcnZlclNvdXJjZUNvbmYgfCB7fSA9IHt9KSB7XG4gICAgc3VwZXIoKTtcblxuICAgIHRoaXMuY29uZiA9IG5ldyBTZXJ2ZXJTb3VyY2VDb25mKGNvbmYpO1xuXG4gICAgaWYgKCF0aGlzLmNvbmYuZW5kUG9pbnQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQXQgbGVhc3QgZW5kUG9pbnQgbXVzdCBiZSBzcGVjaWZpZWQgYXMgYSBjb25maWd1cmF0aW9uIG9mIHRoZSBzZXJ2ZXIgZGF0YSBzb3VyY2UuJyk7XG4gICAgfVxuICB9XG5cbiAgY291bnQoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5sYXN0UmVxdWVzdENvdW50O1xuICB9XG5cbiAgZ2V0RWxlbWVudHMoKTogUHJvbWlzZTxhbnk+IHtcbiAgICByZXR1cm4gdGhpcy5yZXF1ZXN0RWxlbWVudHMoKVxuICAgICAgLnBpcGUobWFwKHJlcyA9PiB7XG4gICAgICAgIHRoaXMubGFzdFJlcXVlc3RDb3VudCA9IHRoaXMuZXh0cmFjdFRvdGFsRnJvbVJlc3BvbnNlKHJlcyk7XG4gICAgICAgIHRoaXMuZGF0YSA9IHRoaXMuZXh0cmFjdERhdGFGcm9tUmVzcG9uc2UocmVzKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5kYXRhO1xuICAgICAgfSkpLnRvUHJvbWlzZSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4dHJhY3RzIGFycmF5IG9mIGRhdGEgZnJvbSBzZXJ2ZXIgcmVzcG9uc2VcbiAgICogQHBhcmFtIHJlc1xuICAgKiBAcmV0dXJucyB7YW55fVxuICAgKi9cbiAgcHJvdGVjdGVkIGV4dHJhY3REYXRhRnJvbVJlc3BvbnNlKHJlczogYW55KTogQXJyYXk8YW55PiB7XG4gICAgY29uc3QgcmF3RGF0YSA9IHJlcy5ib2R5O1xuICAgIGNvbnN0IGRhdGEgPSAhIXRoaXMuY29uZi5kYXRhS2V5ID8gZ2V0RGVlcEZyb21PYmplY3QocmF3RGF0YSwgdGhpcy5jb25mLmRhdGFLZXksIFtdKSA6IHJhd0RhdGE7XG5cbiAgICBpZiAoZGF0YSBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgICByZXR1cm4gZGF0YTtcbiAgICB9XG5cbiAgICB0aHJvdyBuZXcgRXJyb3IoYERhdGEgbXVzdCBiZSBhbiBhcnJheS5cbiAgICBQbGVhc2UgY2hlY2sgdGhhdCBkYXRhIGV4dHJhY3RlZCBmcm9tIHRoZSBzZXJ2ZXIgcmVzcG9uc2UgYnkgdGhlIGtleSAnJHt0aGlzLmNvbmYuZGF0YUtleX0nIGV4aXN0cyBhbmQgaXMgYXJyYXkuYCk7XG4gIH1cblxuICAvKipcbiAgICogRXh0cmFjdHMgdG90YWwgcm93cyBjb3VudCBmcm9tIHRoZSBzZXJ2ZXIgcmVzcG9uc2VcbiAgICogTG9va3MgZm9yIHRoZSBjb3VudCBpbiB0aGUgaGVkZXJzIGZpcnN0LCB0aGVuIGluIHRoZSByZXNwb25zZSBib2R5XG4gICAqIEBwYXJhbSByZXNcbiAgICogQHJldHVybnMge2FueX1cbiAgICovXG4gIHByb3RlY3RlZCBleHRyYWN0VG90YWxGcm9tUmVzcG9uc2UocmVzOiBhbnkpOiBudW1iZXIge1xuICAgIGlmIChyZXMuaGVhZGVycy5oYXModGhpcy5jb25mLnRvdGFsS2V5KSkge1xuICAgICAgcmV0dXJuICtyZXMuaGVhZGVycy5nZXQodGhpcy5jb25mLnRvdGFsS2V5KTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgcmF3RGF0YSA9IHJlcy5ib2R5O1xuICAgICAgcmV0dXJuIGdldERlZXBGcm9tT2JqZWN0KHJhd0RhdGEsIHRoaXMuY29uZi50b3RhbEtleSwgMCk7XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIHJlcXVlc3RFbGVtZW50cygpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGxldCBodHRwUGFyYW1zID0gdGhpcy5jcmVhdGVSZXF1ZXNQYXJhbXMoKTtcbiAgICB0aGlzLmVtaXRPblJlcXVlc3RTdGFydChodHRwUGFyYW1zKTtcbiAgICByZXR1cm4gdGhpcy5odHRwLmdldCh0aGlzLmNvbmYuZW5kUG9pbnQsIHsgcGFyYW1zOiBodHRwUGFyYW1zLCBvYnNlcnZlOiAncmVzcG9uc2UnIH0pLnBpcGUoXG4gICAgICBmaW5hbGl6ZSgoKSA9PiB0aGlzLmVtaXRPblJlcXVlc3RFbmQoKSlcbiAgICApLnBpcGUoXG4gICAgICBtYXAoXG4gICAgICAgIHJlcyA9PiB7XG4gICAgICAgICAgdGhpcy5lbWl0T25SZXF1ZXN0Q29tcGxldGUocmVzKTtcbiAgICAgICAgICByZXR1cm4gcmVzO1xuICAgICAgICB9LFxuICAgICAgICBlcnIgPT4ge1xuICAgICAgICAgIHRoaXMuZW1pdE9uUmVxdWVzdEVycm9yKGVycik7XG4gICAgICAgICAgcmV0dXJuIGVycjtcbiAgICAgICAgfVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBvblJlcXVlc3RTdGFydCgpOiBPYnNlcnZhYmxlPEh0dHBQYXJhbXM+IHtcbiAgICByZXR1cm4gdGhpcy5vblJlcXVlc3RTdGFydFNvdXJjZS5hc09ic2VydmFibGUoKTtcbiAgfVxuXG4gIG9uUmVxdWVzdEVuZCgpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHJldHVybiB0aGlzLm9uUmVxdWVzdEVuZFNvdXJjZS5hc09ic2VydmFibGUoKTtcbiAgfVxuXG4gIG9uUmVxdWVzdENvbXBsZXRlKCk6IE9ic2VydmFibGU8SHR0cFJlc3BvbnNlPE9iamVjdD4+IHtcbiAgICByZXR1cm4gdGhpcy5vblJlcXVlc3RDb21wbGV0ZVNvdXJjZS5hc09ic2VydmFibGUoKTtcbiAgfVxuXG4gIG9uUmVxdWVzdEVycm9yKCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIHRoaXMub25SZXF1ZXN0RXJyb3JTb3VyY2UuYXNPYnNlcnZhYmxlKCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgZW1pdE9uUmVxdWVzdFN0YXJ0KGVsZW1lbnQ6IEh0dHBQYXJhbXMpIHtcbiAgICB0aGlzLm9uUmVxdWVzdFN0YXJ0U291cmNlLm5leHQoZWxlbWVudCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgZW1pdE9uUmVxdWVzdEVuZCgpIHtcbiAgICB0aGlzLm9uUmVxdWVzdEVuZFNvdXJjZS5uZXh0KCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgZW1pdE9uUmVxdWVzdENvbXBsZXRlKGVsZW1lbnQ6IEh0dHBSZXNwb25zZTxPYmplY3Q+KSB7XG4gICAgdGhpcy5vblJlcXVlc3RDb21wbGV0ZVNvdXJjZS5uZXh0KGVsZW1lbnQpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGVtaXRPblJlcXVlc3RFcnJvcihlbGVtZW50KSB7XG4gICAgdGhpcy5vblJlcXVlc3RFcnJvclNvdXJjZS5uZXh0KGVsZW1lbnQpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGNyZWF0ZVJlcXVlc1BhcmFtcygpOiBIdHRwUGFyYW1zIHtcbiAgICBsZXQgaHR0cFBhcmFtcyA9IG5ldyBIdHRwUGFyYW1zKCk7XG5cbiAgICBodHRwUGFyYW1zID0gdGhpcy5hZGRTb3J0UmVxdWVzdFBhcmFtcyhodHRwUGFyYW1zKTtcbiAgICBodHRwUGFyYW1zID0gdGhpcy5hZGRGaWx0ZXJSZXF1ZXN0UGFyYW1zKGh0dHBQYXJhbXMpO1xuICAgIHJldHVybiB0aGlzLmFkZFBhZ2VyUmVxdWVzdFBhcmFtcyhodHRwUGFyYW1zKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBhZGRTb3J0UmVxdWVzdFBhcmFtcyhodHRwUGFyYW1zOiBIdHRwUGFyYW1zKTogSHR0cFBhcmFtcyB7XG4gICAgaWYgKHRoaXMuc29ydENvbmYpIHtcbiAgICAgIHRoaXMuc29ydENvbmYuZm9yRWFjaCgoZmllbGRDb25mKSA9PiB7XG4gICAgICAgIGh0dHBQYXJhbXMgPSBodHRwUGFyYW1zLnNldCh0aGlzLmNvbmYuc29ydEZpZWxkS2V5LCBmaWVsZENvbmYuZmllbGQpO1xuICAgICAgICBodHRwUGFyYW1zID0gaHR0cFBhcmFtcy5zZXQodGhpcy5jb25mLnNvcnREaXJLZXksIGZpZWxkQ29uZi5kaXJlY3Rpb24udG9VcHBlckNhc2UoKSk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gaHR0cFBhcmFtcztcbiAgfVxuXG4gIHByb3RlY3RlZCBhZGRGaWx0ZXJSZXF1ZXN0UGFyYW1zKGh0dHBQYXJhbXM6IEh0dHBQYXJhbXMpOiBIdHRwUGFyYW1zIHtcblxuICAgIGlmICh0aGlzLmZpbHRlckNvbmYuZmlsdGVycykge1xuICAgICAgdGhpcy5maWx0ZXJDb25mLmZpbHRlcnMuZm9yRWFjaCgoZmllbGRDb25mOiBhbnkpID0+IHtcbiAgICAgICAgaWYgKGZpZWxkQ29uZlsnc2VhcmNoJ10pIHtcbiAgICAgICAgICBodHRwUGFyYW1zID0gaHR0cFBhcmFtcy5zZXQodGhpcy5jb25mLmZpbHRlckZpZWxkS2V5LnJlcGxhY2UoJyNmaWVsZCMnLCBmaWVsZENvbmZbJ2ZpZWxkJ10pLCBmaWVsZENvbmZbJ3NlYXJjaCddKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGh0dHBQYXJhbXM7XG4gIH1cblxuICBwcm90ZWN0ZWQgYWRkUGFnZXJSZXF1ZXN0UGFyYW1zKGh0dHBQYXJhbXM6IEh0dHBQYXJhbXMpOiBIdHRwUGFyYW1zIHtcblxuICAgIGlmICh0aGlzLnBhZ2luZ0NvbmYgJiYgdGhpcy5wYWdpbmdDb25mWydwYWdlJ10gJiYgdGhpcy5wYWdpbmdDb25mWydwZXJQYWdlJ10pIHtcbiAgICAgIGh0dHBQYXJhbXMgPSBodHRwUGFyYW1zLnNldCh0aGlzLmNvbmYucGFnZXJQYWdlS2V5LCB0aGlzLnBhZ2luZ0NvbmZbJ3BhZ2UnXSk7XG4gICAgICBodHRwUGFyYW1zID0gaHR0cFBhcmFtcy5zZXQodGhpcy5jb25mLnBhZ2VyTGltaXRLZXksIHRoaXMucGFnaW5nQ29uZlsncGVyUGFnZSddKTtcbiAgICB9XG5cbiAgICByZXR1cm4gaHR0cFBhcmFtcztcbiAgfVxufVxuIl19